<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>{% block title %} Index {% endblock %}</title>
    <!--    <link rel="stylesheet" href="../static/css/main.css">-->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.4"
            integrity="sha384-zUfuhFKKZCbHTY6aRR46gxiqszMk5tcHjsVFxnUo8VMus4kHGVdIYVbOYYNlKmHV"
            crossorigin="anonymous"></script>
    <!-- font awesome-->
    <script src="https://kit.fontawesome.com/34be06a8e3.js" crossorigin="anonymous"></script>
</head>
<body class="bg-black text-white">
{% include "components/navbar.html" %}
<div class="flex pt-16 flex-col h-screen">
    <!-- Sidebar -->
    {% include "components/sidebar.html" %}
    <!-- Main Content -->
    <main id="content-area" class="flex-1 pl-64 p-10">
        {% block content %} {% include "index_content.html" %} {% endblock %}
    </main>
    <div class="pl-64 sticky bottom-0" hx-get="/audiobook/last-played" hx-trigger="load" id="player-container">
    </div>

</div>
</body>

<script>
    let playerIntervalId = 0;
    let currentBookId = -1;

    const getCurrentPlayerTime = () => {
        return document.getElementById('audiobook-player').currentTime;
    }

    document.addEventListener("htmx:afterRequest", (e) => {
        if (e.detail.target.id === 'audiobook-player' && e.detail.elt.id === 'play-from-detail-btn') {
            let audio = document.getElementById('audiobook-player');
            let book_id = audio.lastElementChild.id;
            currentBookId = parseBookIdFromSource(book_id);
            createInterval();
            audio.play();
        }
    });

    const attachInterval = (bookId) => {
        currentBookId = bookId;
        document.getElementById('audiobook-player').onplay = () => {
            createInterval(bookId)
        }
    };

    // TODO: prolong interval
    const createInterval = () => {
        playerIntervalId  = setInterval(() => {
            fetch(`/audiobook/${currentBookId}/active?position=${getCurrentPlayerTime()}`, {
                method: "PUT",
            });
        }, 5_000);
    }

    const parseBookIdFromSource = (sourceId ) => {
        return sourceId.slice(7, sourceId.length);
    };

</script>
</html>