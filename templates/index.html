<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>{% block title %} AudioHub {% endblock %}</title>
    <!--    <link rel="stylesheet" href="../static/css/main.css">-->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.4"
            integrity="sha384-zUfuhFKKZCbHTY6aRR46gxiqszMk5tcHjsVFxnUo8VMus4kHGVdIYVbOYYNlKmHV"
            crossorigin="anonymous"></script>
    <!-- font awesome-->
    <script src="https://kit.fontawesome.com/34be06a8e3.js" crossorigin="anonymous"></script>
</head>
<body class="bg-black text-white">
{% block navbar %}
    {% include "components/navbar.html" %}
{% endblock %}
<div class="flex pt-16 flex-col h-screen">
    <!-- Sidebar -->
    {% include "components/sidebar.html" %}
    <!-- Main Content -->
    <main id="content-area" class="flex-1 pl-64 p-10">
        {% block content %} {% include "index_content.html" %} {% endblock %}
    </main>
    <div id="player-container" class="pl-64 sticky bottom-0" hx-get="/audiobook/last-played" hx-trigger="load" hx-swap="outerHTML" >
    </div>

</div>
</body>

<script>
    let playerIntervalId = 0;
    let currentBookId = -1;

    const getCurrentPlayerTime = () => {
        return document.getElementById('audiobook-player').currentTime;;
    }

    const getBeginningPlayerTime = () => {
        return document.getElementById('audiobook-player').getAttribute("begin-time");

    }
    // player init
    document.addEventListener("htmx:load", (e) => {
        if (e.detail.elt.id === 'player-container') {
            clearInterval(playerIntervalId);
            let audio = document.getElementById('audiobook-player');
            let bookId = audio.lastElementChild.id;
            attachInterval(parseBookIdFromSource(bookId));

            audio.play();

            let beginTime = getBeginningPlayerTime();
            // initially set active book to current selection
            fetch(`/audiobook/${currentBookId}/active?position=${beginTime}`, {
                method: "PUT",
            });
            audio.currentTime = beginTime;

            audio.onpause = () => {
                clearInterval(playerIntervalId);
            }

            audio.onended = () => {
                clearInterval(playerIntervalId);
                updateActiveBook()
            }

        }
    });


    const attachInterval = (bookId) => {
        currentBookId = bookId;
        document.getElementById('audiobook-player').onplay = () => {
            createInterval(bookId)
        }
    };

    // TODO: prolong interval
    const createInterval = () => {
        playerIntervalId  = setInterval(() => {
           updateActiveBook()
        }, 3_000);
    }

    const parseBookIdFromSource = (sourceId ) => {
        return sourceId.slice(7, sourceId.length);
    };

    const updateActiveBook = () => {
        fetch(`/audiobook/${currentBookId}/active?position=${getCurrentPlayerTime()}`, {
            method: "PUT",
        });
    }

    const attachHideQuickSearchListener = () => {
        document.body.addEventListener('click', hideQuickSearchResults)
    }
    const hideQuickSearchResults = () => {
        document.getElementById('quick-search-input').value = '';
        document.getElementById('search-result').style.display = 'none';
        document.body.removeEventListener('click', this);
    }

    // rating clear
    document.addEventListener("htmx:afterRequest", (e) => {
        if (e.detail.elt.id === 'rating-form') {
            document.getElementById('rating-form').reset();
        }
    });

</script>
</html>